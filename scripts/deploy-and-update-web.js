const { ethers } = require("hardhat");
const fs = require("fs");
const path = require("path");

async function main() {
  console.log(
    "Deploying contracts to network:",
    hre?.network?.name || "localhost"
  );

  // Deploy MotorbikeNFT
  const MotorbikeNFT = await ethers.getContractFactory("MotorbikeNFT");
  const nftContract = await MotorbikeNFT.deploy();
  await nftContract.waitForDeployment();

  const nftAddress = await nftContract.getAddress();
  console.log("MotorbikeNFT deployed to:", nftAddress);

  // Deploy MotorbikeMarketplace
  const MotorbikeMarketplace = await ethers.getContractFactory(
    "MotorbikeMarketplace"
  );
  const marketplaceContract = await MotorbikeMarketplace.deploy(nftAddress);
  await marketplaceContract.waitForDeployment();

  const marketplaceAddress = await marketplaceContract.getAddress();
  console.log("MotorbikeMarketplace deployed to:", marketplaceAddress);

  // ABIs as JSON
  const nftAbi = JSON.parse(MotorbikeNFT.interface.formatJson());
  const marketplaceAbi = JSON.parse(
    MotorbikeMarketplace.interface.formatJson()
  );

  // Write to scripts folder (for record)
  fs.writeFileSync(
    path.join(__dirname, "MotorbikeNFT-abi.json"),
    JSON.stringify(nftAbi, null, 2)
  );
  fs.writeFileSync(
    path.join(__dirname, "MotorbikeNFT-address.txt"),
    nftAddress
  );
  fs.writeFileSync(
    path.join(__dirname, "MotorbikeMarketplace-abi.json"),
    JSON.stringify(marketplaceAbi, null, 2)
  );
  fs.writeFileSync(
    path.join(__dirname, "MotorbikeMarketplace-address.txt"),
    marketplaceAddress
  );

  // Write frontend contract files
  const webPath = path.join(__dirname, "..", "web", "src", "blockchain");
  try {
    fs.mkdirSync(webPath, { recursive: true });
  } catch (e) {}

  // NFT contract file
  const nftFile = path.join(webPath, "MotorbikeNFT.js");
  const nftContent = `// This file is auto-generated by scripts/deploy-and-update-web.js\n// NFT Contract address and ABI for the frontend (local Hardhat network)\n\nexport const CONTRACT_ADDRESS = "${nftAddress}";\nexport const ABI = ${JSON.stringify(
    nftAbi,
    null,
    2
  )};\n`;

  // Marketplace contract file
  const marketplaceFile = path.join(webPath, "MotorbikeMarketplace.js");
  const marketplaceContent = `// This file is auto-generated by scripts/deploy-and-update-web.js\n// Marketplace Contract address and ABI for the frontend (local Hardhat network)\n\nexport const MARKETPLACE_ADDRESS = "${marketplaceAddress}";\nexport const MARKETPLACE_ABI = ${JSON.stringify(
    marketplaceAbi,
    null,
    2
  )};\n`;

  fs.writeFileSync(nftFile, nftContent);
  fs.writeFileSync(marketplaceFile, marketplaceContent);

  console.log("Wrote NFT contract file to", nftFile);
  console.log("Wrote Marketplace contract file to", marketplaceFile);
}

main().catch((err) => {
  console.error(err);
  process.exitCode = 1;
});
