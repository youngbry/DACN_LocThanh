const { ethers } = require("hardhat");
const fs = require("fs");
const path = require("path");

async function main() {
  console.log('Deploying MotorbikeNFT to network:', hre?.network?.name || 'localhost');

  const MotorbikeNFT = await ethers.getContractFactory("MotorbikeNFT");
  const contract = await MotorbikeNFT.deploy();
  await contract.waitForDeployment();

  const address = await contract.getAddress();
  console.log("MotorbikeNFT deployed to:", address);

  // ABI as JSON
  const abi = JSON.parse(MotorbikeNFT.interface.formatJson());

  // Write to scripts folder (for record)
  fs.writeFileSync(path.join(__dirname, 'MotorbikeNFT-abi.json'), JSON.stringify(abi, null, 2));
  fs.writeFileSync(path.join(__dirname, 'MotorbikeNFT-address.txt'), address);

  // Also write into web/src/blockchain/MotorbikeNFT.js so frontend uses correct address
  const webPath = path.join(__dirname, '..', 'web', 'src', 'blockchain');
  try {
    fs.mkdirSync(webPath, { recursive: true });
  } catch (e) {}

  const outFile = path.join(webPath, 'MotorbikeNFT.js');
  const content = `// This file is auto-generated by scripts/deploy-and-update-web.js\n// Deploy address and ABI for the frontend (local Hardhat network)\n\nexport const CONTRACT_ADDRESS = "${address}";\nexport const ABI = ${JSON.stringify(abi, null, 2)};\n`;

  fs.writeFileSync(outFile, content);
  console.log('Wrote frontend contract file to', outFile);
}

main().catch((err) => {
  console.error(err);
  process.exitCode = 1;
});
